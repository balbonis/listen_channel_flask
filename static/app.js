let rec=null,ch=[];const btn=document.getElementById('recordBtn');const statusEl=document.getElementById('status');const userEl=document.getElementById('userText');const replyEl=document.getElementById('replyText');const audioEl=document.getElementById('replyAudio');
async function startRec(){ch=[];const stream=await navigator.mediaDevices.getUserMedia({audio:true});rec=new MediaRecorder(stream);rec.ondataavailable=e=>{if(e.data.size>0)ch.push(e.data);};rec.onstop=async()=>{statusEl.textContent='Uploading...';const blob=new Blob(ch,{type:'audio/webm'});const fd=new FormData();fd.append('audio',blob,'rec.webm');try{const r=await fetch('/api/voice',{method:'POST',body:fd});const d=await r.json();if(d.error){statusEl.textContent='Error: '+d.error;return;}userEl.textContent=d.user_text||'';replyEl.textContent=d.reply_text||'';if(d.audio_base64&&d.audio_mime){audioEl.src=`data:${d.audio_mime};base64,${d.audio_base64}`;audioEl.play();}statusEl.textContent='Done';}catch(e){statusEl.textContent='Error';}};rec.start();statusEl.textContent='Recording...';}
btn.onclick=()=>{if(!rec||rec.state==='inactive'){startRec();btn.textContent='â¹ Stop';}else{rec.stop();btn.textContent='ğŸ™ Start Recording';}}